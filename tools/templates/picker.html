<html>
  <head>
    <title>Generic Item Picker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <style>
      body {
        font-family: 'Adobe Clean';
      }

      main {
        padding: 20px;
        font-size: 1.3rem;
        line-height: 1.2em;
      }

      main select {
        font-size: 1rem;
        border: none;
        border-bottom: solid 1px grey;
        padding-top: 5px;
      }
    
      main input {
        width: 50%;
        font-size: 2rem;
        border: none;
        border-bottom: solid 1px grey;
        padding-top: 5px;
      }

      main .filter {
        padding: 20px 10px 20px 10px;
      }

      main button {
        border-radius: 1em;
        padding: 5px 20px;
        font-size: 1.5rem;
      }


      #results {
        display: flex;
        flex-wrap: wrap;
        padding-bottom: 150px;
      }

      #results .item {
        user-select: none;

        margin: 10px;

        max-width: 240px;
        width: 240px; 
        max-height: 240px;
        height: 240px;
        min-height: 240px;

        align-self: flex-end;
        background-color: #dce0e3;
        margin: 15px 8px 65px 16px;
        position: relative;
      }

      #results .item .thumbnail {
        height: 100%;
        position: relative;
        width: 100%;
      }

      #results .item img {
        background: #dce0e3 center center/contain no-repeat;
        height: 100%;
        object-fit: contain;
        width: 100%;
        float: left;
      }

      #results .item a {
        text-decoration: none;
      }

      #results .item .title {
        background-color: #fff;
        border: solid 1px #dce0e3;
        padding: 10px;

        text-align: left;
        font-weight: 400;
        font-size: 13px;
        min-height: 48px;
      }

      #results .selected {
        opacity: 0.2;
        background-color: lightgrey;
      }

      .hidden {
        display: none;
      }

      #selectionPanel {
        position: fixed;
        bottom: 0;
        background-color: lightsalmon;
        padding-bottom: 20px;
        width: 100%;
        box-sizing: border-box;
        left: 0;
        user-select: none;
      }

      #selectionPanel button:disabled {
        background-color: #ccc;
        color: grey;
      }

      #selectionPanel button {
        background-color: #F25749;
        color: white;
        position: absolute;
        right: 10px;
        bottom: 50px;
        border: 1px solid white;
        font-size: 13px;
      }


      #selectionPanel #selectedItems {
        display: flex;
        flex-wrap: wrap;
      }

      #selectionPanel .selectedItem {
        user-select: none;
        margin: 10px;
        max-width: 100px;
        width: 100x;
        max-height: 100px;
        height: 100px;
        min-height: 100px;
        align-self: flex-end;
        background-color: #dce0e3;
        position: relative;
      }

      #selectionPanel .selectedItem img {
        background: #dce0e3 center center/contain no-repeat;
        height: 100%;
        object-fit: contain;
        width: 100%;
        float: left;
      }

    </style>
    <script>
      const COPYBUFFER_ID = 'copybuffer';
      const RESULTS_ID = 'results';

      let picker;

      const selection = new function() {
        this.total = 0;
        this.items = {};

        this.add = (id, item) => {
          this.items[id] = item;
          this.total++;
        };

        this.remove = (id) => {
          if (this.items[id]) {
            delete this.items[id];
            this.total--;
          }
        }
      };

      const unselect = (id) => {
        selection.remove(id);

        const elem = document.querySelector(`#${RESULTS_ID} [data-id="${id}"]`);
        if (elem) {
          elem.classList.remove('selected');
        }
        drawSelection();
      }

      const select = (id, item) => {
        selection.add(id, item);

        const elem = document.querySelector(`#${RESULTS_ID} [data-id="${id}"]`);
        if (elem) {
          elem.classList.add('selected');
        }

        drawSelection();
      }

      const drawSelection = () => {
        const selectedItems = document.getElementById('selectedItems');
        let html = '';
        for(let p in selection.items) {
          const item = selection.items[p];
          html += picker.getSelectedItemHTML ? picker.getSelectedItemHTML(item) : getSelectedItemHTML(item);
        };

        const selectionPanel = document.getElementById('selectionPanel');
        if (html === '') {
          selectionPanel.classList.add('hidden');
          selectedItems.innerHTML = html;
        } else {
          selectedItems.innerHTML = html;
          selectionPanel.classList.remove('hidden');
        }
      }

      const getSelectedItemHTML = (item) => {
        return `<div class="selectedItem" onclick="unselect('${item.id}')">
          <img src="${item.img}">
        </div>`;
      }

      const getItemHTML = (item) => {
        return `<div class="thumbnail">
            <img src="${item.img}">
          </div>
          <a href="${item.link}" target="_blank">
            <div class="title">${item.title}</div>
          </a>`;
      }

      const copyHTMLToClipboard = (html) => {
        const callback = (e) => {
          e.clipboardData.setData('text/html', html);
          e.clipboardData.setData('text/plain', html);
          e.preventDefault();
        };

        document.addEventListener('copy', callback);
        document.execCommand('copy');
        document.removeEventListener('copy', callback);
      };

      const copyToBuffer = () => {
        picker.buffer.clear(COPYBUFFER_ID);

        for(let p in selection.items) {
          picker.buffer.insert(COPYBUFFER_ID, selection.items[p]);
        }

        const div = document.getElementById(COPYBUFFER_ID);
        copyHTMLToClipboard(div.innerHTML);
      }

      const search = async () => {
        const q = document.getElementById('search');
        const items = await picker.find(q.value || '');
        if (items) {
          const resultContainer = document.getElementById(RESULTS_ID);
          resultContainer.innerHTML = '';
          items.forEach(item => {
            const elem = document.createElement('div');
            elem.classList.add('item');
            elem.setAttribute('data-id', item.id);

            elem.innerHTML += picker.getSelectedItemHTML ? picker.getItemHTML(item) : getItemHTML(item);

            elem.addEventListener('click', () => {
              if (elem.classList.contains('selected')) {
                unselect(item.id);
              } else {
                select(item.id, item);
              }
            });

            resultContainer.append(elem);
          });
        }
      }

      const searchOnReturn = (event) => {
        if (event.keyCode === 13) {
          event.preventDefault();
          search();
        }
      }
    </script>
  </head>
  <body>
    <main>
      <h1>Pick your items</h1>
      <div class="filter">
        <input autocomplete="off" placeholder="Type and search" id="search" onkeyup="searchOnReturn(event)">
        <button type="button" onclick="search()">Search</button>
      </div>
      <div id="results"></div>
      <div id="selectionPanel" class="hidden">
        <div id="selectedItems"></div>
        <button type="button" onclick="copyToBuffer()">Copy Selection</button>
      </div>
    </main>
    <div id="pickerNotFound" class="hidden">
      <h1>Your picker has not been found, is invalid or does not respect the API. See DevTools.</h1>
    </div>
    <div class="hidden" id="copybuffer"></div>
    
    <script>
      window.addEventListener('DOMContentLoaded', async () => {
        const url = new URL(window.location.href);
        const modulePath = url.searchParams.get('picker');

        if (modulePath && modulePath.indexOf('/') === 0) {
          // only allow to load same host js file
          try {
            picker = (await import(modulePath)).default;
          } catch (error) {
            console.error(error);
          }
        }

        if (!picker || !picker.buffer) {
          console.error('Your picker is missing or does have a buffer', picker);
          document.querySelector('main').classList.add('hidden');
          document.getElementById('pickerNotFound').classList.remove('hidden');
        }
        
        if (picker.onload) {
          await picker.onload();
        }

        if (picker.buffer.init) {
          picker.buffer.init(COPYBUFFER_ID);
        }
      });
    </script>
  </body>
</html>